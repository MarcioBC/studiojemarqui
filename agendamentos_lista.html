<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Lista de Agendamentos</title>
</head>
<body>
    <h1>Lista de Agendamentos</h1>
    <table border="1">
        <thead>
            <tr>
                <th>Cliente</th>
                <th>Procedimentos</th>
                <th>Data</th>
                <th>Hora</th>
                <th>Valor Total</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody id="appointmentsTableBody"></tbody>
    </table>

    <script>
        // Função para formatar a data no formato dd/mm/aaaa
        function formatDateToDDMMYYYY(dateString) {
            const date = new Date(dateString);
            if (isNaN(date)) return dateString;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Função para carregar os agendamentos
        async function loadAppointments() {
            try {
                const response = await fetch('/api/appointments', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                if (!response.ok) throw new Error('Erro ao buscar agendamentos');

                const appointments = await response.json();
                const tbody = document.getElementById('appointmentsTableBody');
                tbody.innerHTML = '';

                appointments.forEach(appointment => {
                    const row = document.createElement('tr');

                    const clientCell = document.createElement('td');
                    clientCell.textContent = appointment.client ? appointment.client.nome : 'Cliente não encontrado';
                    row.appendChild(clientCell);

                    const proceduresCell = document.createElement('td');
                    if (Array.isArray(appointment.procedures)) {
                        proceduresCell.innerHTML = appointment.procedures.map(p => `
                            <div>
                                <strong>${p.nome}</strong>: R$ ${parseFloat(p.valor).toFixed(2)}
                            </div>
                        `).join('');
                    } else {
                        proceduresCell.textContent = 'Nenhum procedimento';
                    }
                    row.appendChild(proceduresCell);

                    const dateCell = document.createElement('td');
                    dateCell.textContent = formatDateToDDMMYYYY(appointment.date);
                    row.appendChild(dateCell);

                    const timeCell = document.createElement('td');
                    timeCell.textContent = appointment.time;
                    row.appendChild(timeCell);

                    const valueCell = document.createElement('td');
                    valueCell.textContent = `R$ ${parseFloat(appointment.totalValue || 0).toFixed(2)}`;
                    row.appendChild(valueCell);

                    const statusCell = document.createElement('td');
                    statusCell.textContent = appointment.status || 'Pendente';
                    row.appendChild(statusCell);

                    const actionsCell = document.createElement('td');
                    actionsCell.innerHTML = `
                        <button onclick="editAppointment('${appointment._id}')">Editar</button>
                        <button onclick="deleteAppointment('${appointment._id}')">Excluir</button>
                        <button onclick="confirmAppointment('${appointment._id}')">Confirmar</button>
                    `;
                    row.appendChild(actionsCell);

                    tbody.appendChild(row);
                });

            } catch (error) {
                alert(error.message);
            }
        }

        function editAppointment(id) {
            window.location.href = `/appointments/edit.html?id=${id}`;
        }

        async function deleteAppointment(id) {
            if (confirm('Tem certeza que deseja excluir este agendamento?')) {
                try {
                    const response = await fetch(`/api/appointments/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('token')
                        }
                    });

                    if (!response.ok) throw new Error('Erro ao excluir agendamento');
                    alert('Agendamento excluído com sucesso!');
                    loadAppointments();
                } catch (error) {
                    alert(error.message);
                }
            }
        }

        async function confirmAppointment(id) {
            try {
                const response = await fetch(`/api/appointments/${id}/confirm`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token'),
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Erro ao confirmar agendamento');
                alert('Agendamento confirmado com sucesso!');
                loadAppointments();
            } catch (error) {
                alert(error.message);
            }
        }

        window.onload = loadAppointments;
    </script>
</body>
</html>
